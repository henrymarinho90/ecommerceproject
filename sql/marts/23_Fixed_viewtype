DROP VIEW IF EXISTS thelook_analytics.fact_order_items_enriched;

CREATE VIEW thelook_analytics.fact_order_items_enriched AS
SELECT
  oi.id AS order_item_id,
  oi.order_id,
  oi.user_id,
  oi.product_id,
  oi.inventory_item_id,
  oi.status AS order_item_status,

  NULLIF(oi.created_at,'')::timestamptz   AS created_at,
  NULLIF(oi.shipped_at,'')::timestamptz   AS shipped_at,
  NULLIF(oi.delivered_at,'')::timestamptz AS delivered_at,
  NULLIF(oi.returned_at,'')::timestamptz  AS returned_at,

  oi.sale_price::numeric AS sale_price,
  ii.cost::numeric       AS inventory_cost,
  (oi.sale_price::numeric - ii.cost::numeric) AS margin_proxy,

  p.category,
  p.department,
  p.brand,
  p.retail_price::numeric AS retail_price,
  p.distribution_center_id,

  dc.name AS distribution_center_name
FROM thelook_raw.order_items oi
LEFT JOIN thelook_raw.inventory_items ii ON ii.id = oi.inventory_item_id
LEFT JOIN thelook_raw.products p ON p.id = oi.product_id
LEFT JOIN thelook_raw.distribution_centers dc ON dc.id = p.distribution_center_id;

--Sanity check

SELECT
  COUNT(*) AS rows,
  MIN(created_at) AS min_dt,
  MAX(created_at) AS max_dt,
  pg_typeof(MIN(created_at)) AS created_at_type
FROM thelook_analytics.fact_order_items_enriched;
